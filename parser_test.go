package iptables

import (
	"testing"

	"github.com/stretchr/testify/assert"
)

func TestParse(t *testing.T) {
	type TestCase struct {
		line     string
		expected *Log
	}

	testCases := []*TestCase{
		{
			// input log
			line: "2022-07-12T09:01:27.345918+00:00 ubuntu-jammy kernel: [ 1269.733882] IN= foo IN=bar ININ: IN=enp0s3 OUT= MAC=00:b3:dd:bc:29:e1:52:54:00:12:35:02:08:00 SRC=93.184.216.34 DST=10.0.2.15 LEN=44 TOS=0x00 PREC=0x00 TTL=64 ID=15989 PROTO=TCP SPT=80 DPT=54830 SEQ=153856001 ACK=1134538652 WINDOW=65535 RES=0x00 ACK SYN URGP=0 OPT (020405B4)",
			expected: &Log{
				Timestamp:              "2022-07-12T09:01:27.345918+00:00",
				Hostname:               "ubuntu-jammy",
				KernelTimestamp:        1269.733882,
				Prefix:                 "IN= foo IN=bar ININ:",
				InputInterface:         "enp0s3",
				OutputInterface:        "",
				MACAddress:             "00:b3:dd:bc:29:e1:52:54:00:12:35:02:08:00",
				Source:                 "93.184.216.34",
				Destination:            "10.0.2.15",
				Length:                 44,
				ToS:                    0,
				Precedence:             0,
				TTL:                    64,
				ID:                     15989,
				CongestionExperienced:  false,
				DoNotFragment:          false,
				MoreFragmentsFollowing: false,
				Frag:                   0,
				IPOptions:              "",
				Protocol:               "TCP",
				Type:                   0,
				Code:                   0,
				SourcePort:             80,
				DestinationPort:        54830,
				Sequence:               153856001,
				AckSequence:            1134538652,
				WindowSize:             65535,
				Res:                    0,
				Urgent:                 false,
				Ack:                    true,
				Push:                   false,
				Reset:                  false,
				Syn:                    true,
				Fin:                    false,
				Urgp:                   0,
				TCPOption:              "020405B4",
			},
		},
		{
			// input log with various timestamp, without prefix
			line: "Jul 20 13:24:22 ubuntu-jammy kernel: [  396.854443] IN=enp0s3 OUT= MAC=00:b3:dd:bc:29:e1:52:54:00:12:35:02:08:00 SRC=10.0.2.2 DST=10.0.2.15 LEN=76 TOS=0x00 PREC=0x00 TTL=64 ID=5525 PROTO=TCP SPT=59076 DPT=22 WINDOW=65535 RES=0x00 ACK PSH URGP=0",
			expected: &Log{
				Timestamp:              "Jul 20 13:24:22",
				Hostname:               "ubuntu-jammy",
				KernelTimestamp:        396.854443,
				Prefix:                 "",
				InputInterface:         "enp0s3",
				OutputInterface:        "",
				MACAddress:             "00:b3:dd:bc:29:e1:52:54:00:12:35:02:08:00",
				Source:                 "10.0.2.2",
				Destination:            "10.0.2.15",
				Length:                 76,
				ToS:                    0,
				Precedence:             0,
				TTL:                    64,
				ID:                     5525,
				CongestionExperienced:  false,
				DoNotFragment:          false,
				MoreFragmentsFollowing: false,
				Frag:                   0,
				IPOptions:              "",
				Protocol:               "TCP",
				Type:                   0,
				Code:                   0,
				SourcePort:             59076,
				DestinationPort:        22,
				Sequence:               0,
				AckSequence:            0,
				WindowSize:             65535,
				Res:                    0,
				Urgent:                 false,
				Ack:                    true,
				Push:                   true,
				Reset:                  false,
				Syn:                    false,
				Fin:                    false,
				Urgp:                   0,
				TCPOption:              "",
			},
		},
		{
			// output log
			line: "Jul 21 05:31:48 ubuntu-jammy kernel: [14479.122228] OUT-LOG: IN= OUT=enp0s3 SRC=10.0.2.15 DST=93.184.216.34 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=64125 DF PROTO=TCP SPT=54832 DPT=80 SEQ=567002889 ACK=0 WINDOW=64240 RES=0x00 SYN URGP=0 OPT (020405B40402080A12A016080000000001030307)",
			expected: &Log{
				Timestamp:              "Jul 21 05:31:48",
				Hostname:               "ubuntu-jammy",
				KernelTimestamp:        14479.122228,
				Prefix:                 "OUT-LOG:",
				InputInterface:         "",
				OutputInterface:        "enp0s3",
				MACAddress:             "",
				Source:                 "10.0.2.15",
				Destination:            "93.184.216.34",
				Length:                 60,
				ToS:                    0,
				Precedence:             0,
				TTL:                    64,
				ID:                     64125,
				CongestionExperienced:  false,
				DoNotFragment:          true,
				MoreFragmentsFollowing: false,
				Frag:                   0,
				IPOptions:              "",
				Protocol:               "TCP",
				Type:                   0,
				Code:                   0,
				SourcePort:             54832,
				DestinationPort:        80,
				Sequence:               567002889,
				AckSequence:            0,
				WindowSize:             64240,
				Res:                    0,
				Urgent:                 false,
				Ack:                    false,
				Push:                   false,
				Reset:                  false,
				Syn:                    true,
				Fin:                    false,
				Urgp:                   0,
				TCPOption:              "020405B40402080A12A016080000000001030307",
			},
		},
		{
			// ICMP out log
			line: "Jul 21 05:38:28 ubuntu-jammy kernel: [14879.600492] OUT-LOG: IN= OUT=enp0s3 SRC=10.0.2.15 DST=8.8.8.8 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=6495 DF PROTO=ICMP TYPE=8 CODE=0 ID=1 SEQ=3",
			expected: &Log{
				Timestamp:              "Jul 21 05:38:28",
				Hostname:               "ubuntu-jammy",
				KernelTimestamp:        14879.600492,
				Prefix:                 "OUT-LOG:",
				InputInterface:         "",
				OutputInterface:        "enp0s3",
				MACAddress:             "",
				Source:                 "10.0.2.15",
				Destination:            "8.8.8.8",
				Length:                 84,
				ToS:                    0,
				Precedence:             0,
				TTL:                    64,
				ID:                     6495,
				CongestionExperienced:  false,
				DoNotFragment:          true,
				MoreFragmentsFollowing: false,
				Frag:                   0,
				IPOptions:              "",
				Protocol:               "ICMP",
				Type:                   8,
				Code:                   0,
				SourcePort:             0,
				DestinationPort:        0,
				Sequence:               0,
				AckSequence:            0,
				WindowSize:             0,
				Res:                    0,
				Urgent:                 false,
				Ack:                    false,
				Push:                   false,
				Reset:                  false,
				Syn:                    false,
				Fin:                    false,
				Urgp:                   0,
				TCPOption:              "",
			},
		},
		{
			// with options and flags (technically this log has invalid status, e.g. SYN and FIN must not appear together)
			line: "2022-07-12T09:01:27.345918+00:00 ubuntu-jammy kernel: [ 1269.733882] IN=enp0s3 OUT= MAC=00:b3:dd:bc:29:e1:52:54:00:12:35:02:08:00 SRC=93.184.216.34 DST=10.0.2.15 LEN=44 TOS=0x01 PREC=0x02 TTL=64 ID=15989 CE DF MF FRAG=123 OPT (0123456789) PROTO=TCP SPT=80 DPT=54830 SEQ=153856001 ACK=1134538652 WINDOW=65535 RES=0x03 URG ACK PSH RST SYN FIN URGP=4 OPT (020405B4)",
			expected: &Log{
				Timestamp:              "2022-07-12T09:01:27.345918+00:00",
				Hostname:               "ubuntu-jammy",
				KernelTimestamp:        1269.733882,
				Prefix:                 "",
				InputInterface:         "enp0s3",
				OutputInterface:        "",
				MACAddress:             "00:b3:dd:bc:29:e1:52:54:00:12:35:02:08:00",
				Source:                 "93.184.216.34",
				Destination:            "10.0.2.15",
				Length:                 44,
				ToS:                    1,
				Precedence:             2,
				TTL:                    64,
				ID:                     15989,
				CongestionExperienced:  true,
				DoNotFragment:          true,
				MoreFragmentsFollowing: true,
				Frag:                   123,
				IPOptions:              "0123456789",
				Protocol:               "TCP",
				Type:                   0,
				Code:                   0,
				SourcePort:             80,
				DestinationPort:        54830,
				Sequence:               153856001,
				AckSequence:            1134538652,
				WindowSize:             65535,
				Res:                    3,
				Urgent:                 true,
				Ack:                    true,
				Push:                   true,
				Reset:                  true,
				Syn:                    true,
				Fin:                    true,
				Urgp:                   4,
				TCPOption:              "020405B4",
			},
		},
	}

	for _, testCase := range testCases {
		parsedLog, err := Parse(testCase.line)
		if err != nil {
			t.Fatal(err)
		}
		assert.EqualValues(t, testCase.expected, parsedLog)
	}
}
